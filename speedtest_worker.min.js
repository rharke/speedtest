var testStatus=0;var dlStatus="";var ulStatus="";var pingStatus="";var jitterStatus="";var clientIp="";var log="";function tlog(s){log+=Date.now()+": "+s+"\n"}function twarn(s){log+=Date.now()+" WARN: "+s+"\n";console.warn(s)}var settings={time_ul:15,time_dl:15,time_ulGraceTime:3,time_dlGraceTime:1.5,count_ping:35,url_dl:"garbage.php",url_ul:"empty.php",url_ping:"empty.php",url_getIp:"getIP.php",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_ignoreErrors:1,xhr_dlUseBlob:false,garbagePhp_chunkSize:20,enable_quirks:true,overheadCompensationFactor:1048576/925e3,telemetry_level:0,url_telemetry:"telemetry.php",url_prefixes:[""]};var xhr=null;var interval=null;function url_sep(url){return url.match(/\?/)?"&":"?"}this.addEventListener("message",function(e){var params=e.data.split(" ");if(params[0]==="status"){postMessage(testStatus+";"+dlStatus+";"+ulStatus+";"+pingStatus+";"+clientIp+";"+jitterStatus)}if(params[0]==="start"&&testStatus===0){testStatus=1;try{var s={};try{var ss=e.data.substring(5);if(ss)s=JSON.parse(ss)}catch(e){twarn("Error parsing custom settings JSON. Please check your syntax")}if(typeof s.url_dl!=="undefined")settings.url_dl=s.url_dl;if(typeof s.url_ul!=="undefined")settings.url_ul=s.url_ul;if(typeof s.url_ping!=="undefined")settings.url_ping=s.url_ping;if(typeof s.url_getIp!=="undefined")settings.url_getIp=s.url_getIp;if(typeof s.time_dl!=="undefined")settings.time_dl=s.time_dl;if(typeof s.time_ul!=="undefined")settings.time_ul=s.time_ul;if(typeof s.enable_quirks!=="undefined")settings.enable_quirks=s.enable_quirks;if(typeof s.url_prefixes!=="undefined")settings.url_prefixes=s.url_prefixes;if(settings.enable_quirks){var ua=navigator.userAgent;if(/Firefox.(\d+\.\d+)/i.test(ua)){settings.xhr_ulMultistream=1}if(/Edge.(\d+\.\d+)/i.test(ua)){settings.xhr_dlMultistream=3;if(/Edge\/15.(\d+)/i.test(ua)){settings.forceIE11Workaround=true}}if(/Chrome.(\d+)/i.test(ua)&&!!self.fetch){settings.xhr_dlMultistream=5}}if(typeof s.count_ping!=="undefined")settings.count_ping=s.count_ping;if(typeof s.xhr_dlMultistream!=="undefined")settings.xhr_dlMultistream=s.xhr_dlMultistream;if(typeof s.xhr_ulMultistream!=="undefined")settings.xhr_ulMultistream=s.xhr_ulMultistream;if(typeof s.xhr_ignoreErrors!=="undefined")settings.xhr_ignoreErrors=s.xhr_ignoreErrors;if(typeof s.xhr_dlUseBlob!=="undefined")settings.xhr_dlUseBlob=s.xhr_dlUseBlob;if(typeof s.garbagePhp_chunkSize!=="undefined")settings.garbagePhp_chunkSize=s.garbagePhp_chunkSize;if(typeof s.time_dlGraceTime!=="undefined")settings.time_dlGraceTime=s.time_dlGraceTime;if(typeof s.time_ulGraceTime!=="undefined")settings.time_ulGraceTime=s.time_ulGraceTime;if(typeof s.overheadCompensationFactor!=="undefined")settings.overheadCompensationFactor=s.overheadCompensationFactor;if(typeof s.telemetry_level!=="undefined")settings.telemetry_level=s.telemetry_level==="basic"?1:s.telemetry_level==="full"?2:0;if(typeof s.url_telemetry!=="undefined")settings.url_telemetry=s.url_telemetry}catch(e){twarn("Possible error in custom test settings. Some settings may not be applied. Exception: "+e)}tlog(JSON.stringify(settings));getIp(function(){dlTest(function(){testStatus=2;pingTest(function(){testStatus=3;ulTest(function(){testStatus=4;sendTelemetry()})})})})}if(params[0]==="abort"){tlog("manually aborted");clearRequests();if(interval)clearInterval(interval);if(settings.telemetry_level>1)sendTelemetry();testStatus=5;dlStatus="";ulStatus="";pingStatus="";jitterStatus=""}});function clearRequests(){tlog("stopping pending XHRs");if(xhr){for(var i=0;i<xhr.length;i++){try{xhr[i].onprogress=null;xhr[i].onload=null;xhr[i].onerror=null}catch(e){}try{xhr[i].upload.onprogress=null;xhr[i].upload.onload=null;xhr[i].upload.onerror=null}catch(e){}try{xhr[i].abort()}catch(e){}try{delete xhr[i]}catch(e){}}xhr=null}}function getIp(done){tlog("getIp");if(settings.url_getIp=="-1"){done();return}xhr=new XMLHttpRequest;xhr.onload=function(){tlog("IP: "+xhr.responseText);clientIp=xhr.responseText;done()};xhr.onerror=function(){tlog("getIp failed");done()};xhr.open("GET",settings.url_getIp+url_sep(settings.url_getIp)+"r="+Math.random(),true);xhr.send()}var dlCalled=false;function dlTest(done){tlog("dlTest");if(dlCalled)return;else dlCalled=true;if(settings.url_dl==="-1"){done();return}var totLoaded=0,startT=(new Date).getTime(),graceTimeDone=false,failed=false;xhr=[];var testStream=function(i,delay){setTimeout(function(){if(testStatus!==1)return;tlog("dl test stream started "+i+" "+delay);var prevLoaded=0;var x=new XMLHttpRequest;xhr[i]=x;xhr[i].onprogress=function(event){tlog("dl stream progress event "+i+" "+event.loaded);if(testStatus!==1){try{x.abort()}catch(e){}}var loadDiff=event.loaded<=0?0:event.loaded-prevLoaded;if(isNaN(loadDiff)||!isFinite(loadDiff)||loadDiff<0)return;totLoaded+=loadDiff;prevLoaded=event.loaded}.bind(this);xhr[i].onload=function(){tlog("dl stream finished "+i);try{xhr[i].abort()}catch(e){}testStream(i,0)}.bind(this);xhr[i].onerror=function(){tlog("dl stream failed "+i);if(settings.xhr_ignoreErrors===0)failed=true;try{xhr[i].abort()}catch(e){}delete xhr[i];if(settings.xhr_ignoreErrors===1)testStream(i,100)}.bind(this);try{if(settings.xhr_dlUseBlob)xhr[i].responseType="blob";else xhr[i].responseType="arraybuffer"}catch(e){}xhr[i].open("GET",settings.url_prefixes[i%settings.url_prefixes.length]+settings.url_dl+url_sep(settings.url_dl)+"r="+Math.random()+"&ckSize="+settings.garbagePhp_chunkSize,true);xhr[i].send()}.bind(this),1+delay)}.bind(this);for(var i=0;i<settings.xhr_dlMultistream;i++){testStream(i,100*i)}interval=setInterval(function(){tlog("DL: "+dlStatus+(graceTimeDone?"":" (in grace time)"));var t=(new Date).getTime()-startT;if(t<200)return;if(!graceTimeDone){if(t>1e3*settings.time_dlGraceTime){if(totLoaded>0){startT=(new Date).getTime();totLoaded=0}graceTimeDone=true}}else{var speed=totLoaded/(t/1e3);dlStatus=(speed*8*settings.overheadCompensationFactor/1048576).toFixed(2);if(t/1e3>settings.time_dl&&dlStatus>0||failed){if(failed||isNaN(dlStatus))dlStatus="Fail";clearRequests();clearInterval(interval);tlog("dlTest finished "+dlStatus);done()}}}.bind(this),200)}var r=new ArrayBuffer(1048576);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}var req=[];var reqsmall=[];for(var i=0;i<20;i++)req.push(r);req=new Blob(req);r=new ArrayBuffer(262144);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}reqsmall.push(r);reqsmall=new Blob(reqsmall);var ulCalled=false;function ulTest(done){tlog("ulTest");if(ulCalled)return;else ulCalled=true;if(settings.url_ul==="-1"){done();return}var totLoaded=0,startT=(new Date).getTime(),graceTimeDone=false,failed=false;xhr=[];var testStream=function(i,delay){setTimeout(function(){if(testStatus!==3)return;tlog("ul test stream started "+i+" "+delay);var prevLoaded=0;var x=new XMLHttpRequest;xhr[i]=x;var ie11workaround;if(settings.forceIE11Workaround)ie11workaround=true;else{try{xhr[i].upload.onprogress;ie11workaround=false}catch(e){ie11workaround=true}}if(ie11workaround){xhr[i].onload=function(){tlog("ul stream progress event (ie11wa)");totLoaded+=262144;testStream(i,0)};xhr[i].onerror=function(){tlog("ul stream failed (ie11wa)");if(settings.xhr_ignoreErrors===0)failed=true;try{xhr[i].abort()}catch(e){}delete xhr[i];if(settings.xhr_ignoreErrors===1)testStream(i,100)};xhr[i].open("POST",settings.url_prefixes[i%settings.url_prefixes.length]+settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),true);xhr[i].setRequestHeader("Content-Encoding","identity");xhr[i].send(reqsmall)}else{xhr[i].upload.onprogress=function(event){tlog("ul stream progress event "+i+" "+event.loaded);if(testStatus!==3){try{x.abort()}catch(e){}}var loadDiff=event.loaded<=0?0:event.loaded-prevLoaded;if(isNaN(loadDiff)||!isFinite(loadDiff)||loadDiff<0)return;totLoaded+=loadDiff;prevLoaded=event.loaded}.bind(this);xhr[i].upload.onload=function(){tlog("ul stream finished "+i);testStream(i,0)}.bind(this);xhr[i].upload.onerror=function(){tlog("ul stream failed "+i);if(settings.xhr_ignoreErrors===0)failed=true;try{xhr[i].abort()}catch(e){}delete xhr[i];if(settings.xhr_ignoreErrors===1)testStream(i,100)}.bind(this);xhr[i].open("POST",settings.url_prefixes[i%settings.url_prefixes.length]+settings.url_ul+url_sep(settings.url_ul)+"r="+Math.random(),true);xhr[i].setRequestHeader("Content-Encoding","identity");xhr[i].send(req)}}.bind(this),1)}.bind(this);for(var i=0;i<settings.xhr_ulMultistream;i++){testStream(i,100*i)}interval=setInterval(function(){tlog("UL: "+ulStatus+(graceTimeDone?"":" (in grace time)"));var t=(new Date).getTime()-startT;if(t<200)return;if(!graceTimeDone){if(t>1e3*settings.time_ulGraceTime){if(totLoaded>0){startT=(new Date).getTime();totLoaded=0}graceTimeDone=true}}else{var speed=totLoaded/(t/1e3);ulStatus=(speed*8*settings.overheadCompensationFactor/1048576).toFixed(2);if(t/1e3>settings.time_ul&&ulStatus>0||failed){if(failed||isNaN(ulStatus))ulStatus="Fail";clearRequests();clearInterval(interval);tlog("ulTest finished "+ulStatus);done()}}}.bind(this),200)}var ptCalled=false;function pingTest(done){tlog("pingTest");if(ptCalled)return;else ptCalled=true;if(settings.url_ping==="-1"){done();return}var prevT=null;var ping=0;var jitter=0;var i=0;var prevInstspd=0;xhr=[];var doPing=function(){tlog("ping");prevT=(new Date).getTime();xhr[0]=new XMLHttpRequest;xhr[0].onload=function(){tlog("pong");if(i===0){prevT=(new Date).getTime()}else{var instspd=(new Date).getTime()-prevT;var instjitter=Math.abs(instspd-prevInstspd);if(i===1)ping=instspd;else{ping=ping*.9+instspd*.1;jitter=instjitter>jitter?jitter*.2+instjitter*.8:jitter*.9+instjitter*.1}prevInstspd=instspd}pingStatus=ping.toFixed(2);jitterStatus=jitter.toFixed(2);i++;tlog("PING: "+pingStatus+" JITTER: "+jitterStatus);if(i<settings.count_ping)doPing();else done()}.bind(this);xhr[0].onerror=function(){tlog("ping failed");if(settings.xhr_ignoreErrors===0){pingStatus="Fail";jitterStatus="Fail";clearRequests();done()}if(settings.xhr_ignoreErrors===1)doPing();if(settings.xhr_ignoreErrors===2){i++;if(i<settings.count_ping)doPing();else done()}}.bind(this);xhr[0].open("GET",settings.url_ping+url_sep(settings.url_ping)+"r="+Math.random(),true);xhr[0].send()}.bind(this);doPing()}function sendTelemetry(){if(settings.telemetry_level<1)return;xhr=new XMLHttpRequest;xhr.onload=function(){console.log("TELEMETRY OL "+xhr.responseText)};xhr.onerror=function(){console.log("TELEMETRY ERROR "+xhr)};xhr.open("POST",settings.url_telemetry+"?r="+Math.random(),true);try{var fd=new FormData;fd.append("dl",dlStatus);fd.append("ul",ulStatus);fd.append("ping",pingStatus);fd.append("jitter",jitterStatus);fd.append("log",settings.telemetry_level>1?log:"");xhr.send(fd)}catch(ex){var postData="dl="+encodeURIComponent(dlStatus)+"&ul="+encodeURIComponent(ulStatus)+"&ping="+encodeURIComponent(pingStatus)+"&jitter="+encodeURIComponent(jitterStatus)+"&log="+encodeURIComponent(settings.telemetry_level>1?log:"");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.send(postData)}}